name: Reset Primal - Integrations Automation

on:
  schedule:
    # Health check: Every 1 hour
    - cron: '0 * * * *'
    # Auto-recovery: Every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - '.github/workflows/integrations-automation.yml'

jobs:
  health-check:
    name: Health Check - Monitor All Integrations
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 * * * *' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Load environment variables
        run: |
          cat > .env << 'EOF'
          HOTMART_API_KEY=${{ secrets.HOTMART_API_KEY }}
          HOTMART_WEBHOOK_SECRET=${{ secrets.HOTMART_WEBHOOK_SECRET }}
          GA4_MEASUREMENT_ID=${{ secrets.GA4_MEASUREMENT_ID }}
          GA4_API_SECRET=${{ secrets.GA4_API_SECRET }}
          BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
          BREVO_SENDER_EMAIL=${{ secrets.BREVO_SENDER_EMAIL }}
          AIRTABLE_API_TOKEN=${{ secrets.AIRTABLE_API_TOKEN }}
          AIRTABLE_BASE_ID=${{ secrets.AIRTABLE_BASE_ID }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          META_PIXEL_ID=${{ secrets.META_PIXEL_ID }}
          ZAPIER_WEBHOOK_URL=${{ secrets.ZAPIER_WEBHOOK_URL }}
          EOF

      - name: Run health check
        id: health_check
        working-directory: infrastructure
        run: |
          node health-check.js > health-check-output.log 2>&1
          exit_code=$?
          cat health-check-output.log
          exit $exit_code
        continue-on-error: true

      - name: Upload health check logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: health-check-logs-${{ github.run_id }}
          path: infrastructure/logs/
          retention-days: 30

      - name: Check health status
        id: check_status
        working-directory: infrastructure
        run: |
          if [ -f "logs/health-check-$(date +%Y-%m-%d).json" ]; then
            status=$(jq '.[-1].summary.healthy' logs/health-check-$(date +%Y-%m-%d).json 2>/dev/null || echo "unknown")
            echo "health_status=$status" >> $GITHUB_OUTPUT
          else
            echo "health_status=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack alert on failure
        if: failure() && github.event.schedule != ''
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ðŸš¨ Health Check FAILED
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,workflow
        continue-on-error: true

  auto-recovery:
    name: Auto-Recovery - Fix Problems Automatically
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/30 * * * *' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Load environment variables
        run: |
          cat > .env << 'EOF'
          HOTMART_API_KEY=${{ secrets.HOTMART_API_KEY }}
          HOTMART_WEBHOOK_SECRET=${{ secrets.HOTMART_WEBHOOK_SECRET }}
          GA4_MEASUREMENT_ID=${{ secrets.GA4_MEASUREMENT_ID }}
          GA4_API_SECRET=${{ secrets.GA4_API_SECRET }}
          BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
          BREVO_SENDER_EMAIL=${{ secrets.BREVO_SENDER_EMAIL }}
          AIRTABLE_API_TOKEN=${{ secrets.AIRTABLE_API_TOKEN }}
          AIRTABLE_BASE_ID=${{ secrets.AIRTABLE_BASE_ID }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          META_PIXEL_ID=${{ secrets.META_PIXEL_ID }}
          ZAPIER_WEBHOOK_URL=${{ secrets.ZAPIER_WEBHOOK_URL }}
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          EOF

      - name: Run auto-recovery
        id: auto_recovery
        working-directory: infrastructure
        run: |
          node auto-recovery.js > auto-recovery-output.log 2>&1
          exit_code=$?
          cat auto-recovery-output.log
          exit $exit_code
        continue-on-error: true

      - name: Upload auto-recovery logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: auto-recovery-logs-${{ github.run_id }}
          path: infrastructure/logs/
          retention-days: 30

      - name: Check recovery status
        id: check_recovery
        working-directory: infrastructure
        run: |
          if [ -f "logs/auto-recovery-$(date +%Y-%m-%d).json" ]; then
            failed=$(jq '.[-1].summary.failed' logs/auto-recovery-$(date +%Y-%m-%d).json 2>/dev/null || echo "0")
            needs_manual=$(jq '.[-1].summary.needsManualFix' logs/auto-recovery-$(date +%Y-%m-%d).json 2>/dev/null || echo "0")
            echo "failed_count=$failed" >> $GITHUB_OUTPUT
            echo "manual_fix_count=$needs_manual" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack alert if manual intervention needed
        if: steps.check_recovery.outputs.manual_fix_count > 0
        uses: 8398a7/action-slack@v3
        with:
          status: warning
          text: |
            âš ï¸ Auto-Recovery Needs Manual Intervention
            Services needing manual fix: ${{ steps.check_recovery.outputs.manual_fix_count }}
            Repository: ${{ github.repository }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Check logs: infrastructure/logs/auto-recovery-$(date +%Y-%m-%d).json
            Guide: infrastructure/INTEGRATIONS-TROUBLESHOOTING.md
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,workflow
        continue-on-error: true

      - name: Send Slack success message
        if: success() && steps.check_recovery.outputs.failed_count == '0'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            âœ… All Integrations Healthy & Auto-Recovery Complete
            Failed count: 0
            Manual fix needed: ${{ steps.check_recovery.outputs.manual_fix_count }}
            Repository: ${{ github.repository }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,eventName,workflow
        continue-on-error: true

  summary:
    name: Automation Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [health-check, auto-recovery]

    steps:
      - name: Download all logs
        uses: actions/download-artifact@v3
        with:
          path: all-logs

      - name: Generate summary
        run: |
          echo "## ðŸ“Š Integration Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check Status:** ${{ needs.health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-Recovery Status:** ${{ needs.auto-recovery.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:** Check run artifacts for detailed logs" >> $GITHUB_STEP_SUMMARY
          echo "- health-check-logs-${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- auto-recovery-logs-${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
